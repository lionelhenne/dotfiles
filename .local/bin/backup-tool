#!/bin/bash
set -u

# ==============================================================================
# CONFIGURATION & COLORS
# ==============================================================================
readonly RED=$'\033[0;31m'
readonly GREEN=$'\033[0;32m'
readonly YELLOW=$'\033[0;33m'
readonly BLUE=$'\033[0;34m'
readonly CYAN=$'\033[0;36m'
readonly GRAY=$'\033[0;90m'
readonly WHITE=$'\033[0;97m'
readonly BOLD=$'\033[1m'
readonly RESET=$'\033[0m'

readonly DEFAULT_BACKUP_DIR="$HOME/Library/Mobile Documents/com~apple~CloudDocs/mbuBackups"

# ==============================================================================
# LOGGING & UI UTILS
# ==============================================================================

print_intro() {
    echo
    echo -e "ðŸ“¦ ${BOLD}${BLUE}MAC BACKUP UTILITY ${RESET}"
    echo
}

log_header() { printf "\n${BOLD}${GREEN}=== %s ===${RESET}\n" "$1"; }
log_info()   { printf "${BLUE}[INFO] %s${RESET}\n" "$1"; }
log_warning() { printf "${YELLOW}[WARNING] %s${RESET}\n" "$1"; }
log_error()  { printf "${RED}[ERROR] %s${RESET}\n" "$1" >&2; exit 1; }
log_success(){ printf "${GREEN}[SUCCESS] %s${RESET}\n" "$1"; }

usage() {
    print_intro
    echo -e "${YELLOW}Usage:${RESET}"
    echo -e "  @backup -b <app>   ${GRAY}Backup specific application${RESET}"
    echo -e "  @backup -r <app>   ${GRAY}Restore specific application${RESET}"
    echo -e "  @backup -l         ${GRAY}List available applications${RESET}"
    echo
    echo -e "${YELLOW}Examples:${RESET}"
    echo -e "  @backup -b iconjar"
    echo -e "  @backup -r vscode"
    echo -e "  @backup -l"
    echo
    echo -e "${GRAY}Note: Script searches in current directory first,"
    echo -e "      then falls back to: ${DEFAULT_BACKUP_DIR}${RESET}"
    echo
    exit 1
}

# ==============================================================================
# CORE LOGIC
# ==============================================================================

get_working_directory() {
    local found=0
    
    # Check current directory for any config folders
    for dir in */; do
        if [[ -f "${dir}config.txt" ]]; then
            found=1
            break
        fi
    done
    
    if [[ $found -eq 0 ]]; then
        if [[ -d "$DEFAULT_BACKUP_DIR" ]]; then
            # Output to stderr so it doesn't mess up the echo return
            log_warning "No apps found in current directory." >&2
            log_info "Switching to default directory: ${DEFAULT_BACKUP_DIR}" >&2
            echo "$DEFAULT_BACKUP_DIR"
        else
            log_error "No apps found and default directory does not exist: ${DEFAULT_BACKUP_DIR}"
        fi
    else
        echo "$(pwd)"
    fi
}

read_config() {
    local config_file="$1"
    
    if [[ ! -f "$config_file" ]]; then
        log_error "Config file not found: $config_file"
    fi
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines and comments
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        
        # Variable expansion
        line="${line//\$HOME/$HOME}"
        line="${line/#\~/$HOME}"
        
        # Trim whitespace
        line="${line## }"
        line="${line%% }"
        
        echo "$line"
    done < "$config_file"
}

list_apps() {
    local working_dir
    working_dir=$(get_working_directory)
    cd "$working_dir" || log_error "Cannot access ${working_dir}"
    
    log_header "Available Applications"
    echo -e "${GRAY}Directory: ${working_dir}${RESET}"
    echo
    
    local found=0
    for dir in */; do
        if [[ -f "${dir}config.txt" ]]; then
            echo -e "  ${CYAN}â€¢${RESET} ${dir%/}"
            found=1
        fi
    done
    
    if [[ $found -eq 0 ]]; then
        echo -e "  ${GRAY}(No configured applications found)${RESET}"
    fi
    echo
}

backup() {
    local app="$1"
    local working_dir
    working_dir=$(get_working_directory)
    cd "$working_dir" || log_error "Cannot access ${working_dir}"
    
    local config_file="${app}/config.txt"
    local backup_archive="${app}/backup.tar.gz"
    local temp_dir="/tmp/mbu-${app}-$$"
    
    log_header "Backup: ${app}"
    
    if [[ ! -f "$config_file" ]]; then
        log_error "Config not found: $config_file"
    fi
    
    mkdir -p "$temp_dir"
    
    local count=0
    
    while IFS= read -r path; do
        [[ -z "$path" ]] && continue
        
        if [[ ! -e "$path" ]]; then
            log_warning "Skipped (path does not exist): $path"
            continue
        fi
        
        local relative_path="${path#$HOME/}"
        local dest="${temp_dir}/${relative_path}"
        local dest_dir
        dest_dir="$(dirname "$dest")"
        
        mkdir -p "$dest_dir"
        
        if [[ -d "$path" ]]; then
            rsync -a --delete "$path/" "$dest/" 2>/dev/null
            echo -e "  ${GREEN}âœ“${RESET} ${relative_path}/"
        else
            rsync -a "$path" "$dest" 2>/dev/null
            echo -e "  ${GREEN}âœ“${RESET} ${relative_path}"
        fi
        
        ((count++))
    done < <(read_config "$config_file")
    
    if [[ $count -eq 0 ]]; then
        rm -rf "$temp_dir"
        log_error "No files found to backup."
    fi
    
    log_info "Compressing archive..."
    tar -czf "$backup_archive" -C "$temp_dir" . 2>/dev/null
    
    rm -rf "$temp_dir"
    
    local archive_size
    archive_size=$(du -h "$backup_archive" | cut -f1)
    
    echo
    log_success "Backup completed! (${count} items, ${archive_size})"
}

restore() {
    local app="$1"
    local working_dir
    working_dir=$(get_working_directory)
    cd "$working_dir" || log_error "Cannot access ${working_dir}"
    
    local config_file="${app}/config.txt"
    local backup_archive="${app}/backup.tar.gz"
    local temp_dir="/tmp/mbu-${app}-$$"
    
    log_header "Restore: ${app}"
    
    if [[ ! -f "$config_file" ]]; then
        log_error "Config not found: $config_file"
    fi
    
    if [[ ! -f "$backup_archive" ]]; then
        log_error "Backup archive not found: $backup_archive"
    fi
    
    log_info "Extracting archive..."
    mkdir -p "$temp_dir"
    tar -xzf "$backup_archive" -C "$temp_dir" 2>/dev/null
    
    local count=0
    
    while IFS= read -r path; do
        [[ -z "$path" ]] && continue
        
        local relative_path="${path#$HOME/}"
        local source="${temp_dir}/${relative_path}"
        
        if [[ ! -e "$source" ]]; then
            log_warning "Skipped (not in backup): $relative_path"
            continue
        fi
        
        local parent_dir
        parent_dir="$(dirname "$path")"
        mkdir -p "$parent_dir"
        
        if [[ -d "$source" ]]; then
            mkdir -p "$path"
            rsync -a --delete "$source/" "$path/" 2>/dev/null
            echo -e "  ${GREEN}âœ“${RESET} ${relative_path}/"
        else
            rsync -a "$source" "$path" 2>/dev/null
            echo -e "  ${GREEN}âœ“${RESET} ${relative_path}"
        fi
        
        ((count++))
    done < <(read_config "$config_file")
    
    rm -rf "$temp_dir"
    
    if [[ $count -eq 0 ]]; then
        log_error "No files found to restore."
    fi
    
    echo
    log_success "Restore completed! (${count} items restored)"
}

# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

main() {
    if [[ $# -eq 0 ]]; then
        usage
    fi

    case "$1" in
        -b)
            [[ -z "${2:-}" ]] && log_error "Application name required."
            backup "$2"
            ;;
        -r)
            [[ -z "${2:-}" ]] && log_error "Application name required."
            restore "$2"
            ;;
        -l)
            list_apps
            ;;
        *)
            usage
            ;;
    esac
}

main "$@"