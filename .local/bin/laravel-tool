#!/bin/bash

set -euo pipefail

readonly COMMON_LIB_DIR="$HOME/.local/lib"
readonly LARAVEL_TOOL_PATH="$HOME/Developer/laravel-tool/install.sh"

# ==============================================================================
# LOAD COMMON LIBRARY
# ==============================================================================

if [[ -f "$COMMON_LIB_DIR/_common.sh" ]]; then
    source "$COMMON_LIB_DIR/_common.sh"
fi

# ==============================================================================
# CACHE MANAGEMENT
# ==============================================================================

check_laravel_root() {
    if [[ ! -f "artisan" ]]; then
        log_error "Must be run in a Laravel root"
    fi
}

cache_clear() {
    check_laravel_root
    php artisan cache:clear
    php artisan config:clear
    php artisan route:clear
    php artisan view:clear
    php artisan event:clear
    php artisan optimize:clear
    echo
    log_success "All caches cleared"
}

cache_build() {
    check_laravel_root
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache
    php artisan event:cache
    echo
    log_success "Cache built successfully"
}

# ==============================================================================
# HELP
# ==============================================================================

display_help() {
    local has_tool=false
    [[ -f "$LARAVEL_TOOL_PATH" ]] && has_tool=true

    log_header "Laravel Toolbox"

    if [[ "$has_tool" == true ]]; then
        echo -e "${YELLOW}${BOLD}PROJECT SETUP${RESET}"
        echo -e "  @laravel install       ${SILVER}Install/update project components${RESET}"
        echo
    fi

    echo -e "${YELLOW}${BOLD}CACHE MANAGEMENT${RESET}"
    echo -e "  @laravel cache clear   ${SILVER}Clear all caches${RESET}"
    echo -e "  @laravel cache build   ${SILVER}Build/warm up caches${RESET}"

    if [[ "$has_tool" == true ]]; then
        echo
        echo -e "${YELLOW}${BOLD}AVAILABLE COMPONENTS${RESET}"
        echo -e "  ${SILVER}• Spatie CSP${RESET}"
        echo -e "  ${SILVER}• Cockpit CMS${RESET}"
        echo -e "  ${SILVER}• @tailwindcss/typography${RESET}"
        echo -e "  ${SILVER}• Fonts (Open Sans, Merriweather, JetBrains Mono, etc.)${RESET}"
        echo -e "  ${SILVER}• Template files (CSS/JS/Views)${RESET}"
        echo -e "  ${SILVER}• .env configuration${RESET}"
    else
        echo
        echo -e "${YELLOW}${BOLD}NOTE${RESET}"
        echo -e "  ${SILVER}Project setup tools not found.${RESET}"
        echo -e "  ${SILVER}Install from: https://github.com/yourusername/laravel-tool${RESET}"
    fi

    exit 0
}

# ==============================================================================
# MAIN DISPATCHER
# ==============================================================================

main() {
    local command="${1:-}"
    local subcommand="${2:-}"

    case "$command" in
        install)
            if [[ -f "$LARAVEL_TOOL_PATH" ]]; then
                exec "$LARAVEL_TOOL_PATH" "$@"
            else
                log_error "Setup tool not found at: $LARAVEL_TOOL_PATH"
            fi
            ;;
        cache)
            case "$subcommand" in
                clear)
                    cache_clear
                    ;;
                build)
                    cache_build
                    ;;
                *)
                    display_help
                    ;;
            esac
            ;;
        "")
            display_help
            ;;
        *)
            display_help
            ;;
    esac
}

main "$@"
