#!/bin/bash

set -euo pipefail

readonly SCRIPT_DIR="$HOME/.local/lib"

# ==============================================================================
# LOAD COMMON LIBRARY
# ==============================================================================

if [[ ! -f "$SCRIPT_DIR/_common.sh" ]]; then
    echo "âŒ Common library not found: $SCRIPT_DIR/_common.sh"
    exit 1
fi

source "$SCRIPT_DIR/_common.sh"

# ==============================================================================
# CONFIGURATION
# ==============================================================================

readonly TEMPLATES_DIR="$HOME/Developer/laravel-templates/templates"

# ==============================================================================
# HELPERS
# ==============================================================================

check_prerequisites() {
    if [[ ! -f "artisan" ]]; then 
        log_error "Must be run in a Laravel root"
    fi
    if [[ ! -f ".env" ]]; then 
        log_error ".env not found"
    fi
}

prevent_sleep() {
    if command -v caffeinate >/dev/null 2>&1; then
        caffeinate -dims &
        CAFFEINATE_PID=$!
        trap 'kill "$CAFFEINATE_PID" &>/dev/null 2>&1 || true' EXIT
    fi
}

backup_file() {
    local file="$1"
    local backup_path="backup/$file"
    mkdir -p "$(dirname "$backup_path")"
    if [[ -f "$file" ]]; then 
        cp "$file" "$backup_path"
    fi
}

# ==============================================================================
# MODULE: INSTALL
# ==============================================================================

cmd_install() {
    prevent_sleep
    check_prerequisites
    
    if [[ ! -d "$TEMPLATES_DIR" ]]; then
        log_error "Templates directory not found: $TEMPLATES_DIR"
    fi

    log_header "Laravel Setup"

    # Packages selection
    if confirm "Install Spatie CSP?" Y; then
        INSTALL_CSP=true
    else
        INSTALL_CSP=false
    fi

    if confirm "Install Cockpit CMS?" Y; then
        INSTALL_COCKPIT=true
    else
        INSTALL_COCKPIT=false
    fi

    # Backup files
    log_header "Backups"
    
    local files=(".env" "resources/css/app.css" "resources/js/app.js")
    if [[ "$INSTALL_CSP" == true ]]; then 
        files+=("config/csp.php")
    fi
    
    for file in "${files[@]}"; do 
        backup_file "$file"
        log_info "Backed up: $file"
    done

    # Install Composer packages
    log_header "Composer Packages"
    
    if [[ "$INSTALL_CSP" == true ]]; then
        log_info "Installing Spatie CSP..."
        if composer require spatie/laravel-csp --no-interaction >/dev/null 2>&1; then
            php artisan vendor:publish --tag=csp-config >/dev/null 2>&1
            log_success "Spatie CSP installed"
        else
            log_error "Failed to install Spatie CSP"
        fi
    fi
    
    if [[ "$INSTALL_COCKPIT" == true ]]; then
        log_info "Installing Cockpit CMS..."
        if composer require lionelhenne/laravel-cockpit-cms --no-interaction >/dev/null 2>&1; then
            php artisan vendor:publish --tag="cockpit-config" >/dev/null 2>&1
            log_success "Cockpit CMS installed"
        else
            log_error "Failed to install Cockpit CMS"
        fi
    fi

    # Update .env file
    log_info "Updating .env file..."
    sed -i '' 's|^APP_URL=http://|APP_URL=https://|g' ".env"
    sed -i '' 's|^APP_LOCALE=en$|APP_LOCALE=fr|g' ".env"
    
    if [[ "$INSTALL_CSP" == true ]] && ! grep -q "^CSP_REPORT_URI=" ".env"; then
        cat >> ".env" << 'EOF'

CSP_REPORT_URI=
CSP_ENABLED=false
CSP_ENABLED_WHILE_HOT_RELOADING=false
CSP_NONCE_ENABLED=false
EOF
        log_success "CSP variables added to .env"
    fi

    if [[ "$INSTALL_COCKPIT" == true ]] && ! grep -q "^COCKPIT_GRAPHQL_ENDPOINT=" ".env"; then
        cat >> ".env" << 'EOF'

COCKPIT_URL=
COCKPIT_GRAPHQL_ENDPOINT=
COCKPIT_API_TOKEN=
EOF
        log_success "Cockpit variables added to .env"
    fi
    
    log_success ".env updated"

    # Copy template files
    log_header "Template Files"
    
    local templates=("resources/css/app.css" "resources/css/_base.css" "resources/js/app.js")
    if [[ "$INSTALL_CSP" == true ]]; then 
        templates+=("config/csp.php")
    fi
    
    for template in "${templates[@]}"; do
        local source="${TEMPLATES_DIR}/${template}"
        local dest="${template}"
        
        log_info "Copying ${template}..."
        
        if [[ ! -f "$source" ]]; then
            log_error "Template not found: ${source}"
        fi
        
        mkdir -p "$(dirname "$dest")"
        
        if cp "$source" "$dest"; then
            log_success "Copied: ${template}"
        else
            log_error "Failed to copy: ${template}"
        fi
    done

    # Copy editor configs
    log_info "Adding editor configs..."
    cp "$TEMPLATES_DIR/.editorconfig" .
    cp "$TEMPLATES_DIR/.prettierrc" .
    log_success "Editor configs added"

    echo
    log_success "Installation completed!"
    echo
    log_warn "Don't forget to configure your .env variables"
}

# ==============================================================================
# MODULE: CACHE
# ==============================================================================

display_help() {
    log_header "Laravel Toolbox"
    echo -e "${YELLOW}${BOLD}COMMANDS${RESET}"
    echo -e "  @laravel install       ${SILVER}Run the interactive setup installer${RESET}"
    echo -e "  @laravel cache clear   ${SILVER}Clear all caches${RESET}"
    echo -e "  @laravel cache build   ${SILVER}Build/warm up caches${RESET}"
    exit 0
}

cache_clear_actions() {
    php artisan cache:clear
    php artisan config:clear
    php artisan route:clear
    php artisan view:clear
    php artisan event:clear
    php artisan optimize:clear
    echo
    log_success "All caches cleared"
}

cache_build_actions() {
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache
    php artisan event:cache    
    echo
    log_success "Cache built successfully"
}

cmd_cache() {
    local subaction="${1:-}"

    if [[ "$subaction" == "clear" ]]; then
        check_prerequisites
        cache_clear_actions
    elif [[ "$subaction" == "build" ]]; then
        check_prerequisites
        cache_build_actions
    else
        display_help
    fi
}

# ==============================================================================
# MAIN DISPATCHER
# ==============================================================================

main() {
    local command="${1:-}"
    local arg="${2:-}"

    case "$command" in
        install)
            cmd_install
            ;;
        cache)
            cmd_cache "$arg"
            ;;
        *)
            display_help
            ;;
    esac
}

main "$@"
