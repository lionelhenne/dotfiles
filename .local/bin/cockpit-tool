#!/bin/bash

set -euo pipefail

readonly SCRIPT_DIR="$HOME/.local/lib"

# ==============================================================================
# LOAD COMMON LIBRARY
# ==============================================================================

if [[ ! -f "$SCRIPT_DIR/_common.sh" ]]; then
    echo "âŒ Common library not found: $SCRIPT_DIR/_common.sh"
    exit 1
fi

source "$SCRIPT_DIR/_common.sh"

# ==============================================================================
# CONFIGURATION
# ==============================================================================

readonly URL_DOWNLOAD="https://files.getcockpit.com/releases/master/cockpit-core.zip"

# ==============================================================================
# COMMANDS
# ==============================================================================

cmd_new() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        prompt "Enter the name of your project:" name
        
        if [[ -z "$name" ]]; then
            log_error "Project name cannot be empty"
        fi
    fi

    if [[ -d "$name" ]]; then
        log_error "Directory '$name' already exists"
    fi

    log_header "COCKPIT TOOLBOX | Installing Cockpit CMS"

    # 1. Preparation
    mkdir -p "$name"
    local tmp_zip="/tmp/cockpit_install_$$.zip"

    # 2. Download
    log_info "Downloading Cockpit Core..."
    if curl -fsSL "$URL_DOWNLOAD" -o "$tmp_zip"; then
        log_success "Downloaded from getcockpit.com"
    else
        rm -f "$tmp_zip"
        rmdir "$name"
        log_error "Unable to download Cockpit"
    fi

    # 3. Extraction
    log_info "Extracting files into './$name'..."
    if ! unzip -q "$tmp_zip" -d "$name"; then
        rm -f "$tmp_zip"
        log_error "Decompression failed"
    fi
    rm -f "$tmp_zip"
    log_success "Files extracted"

    # 4. Structure Flattening
    local num_files
    num_files=$(ls -1A "$name" | wc -l)

    if [[ "$num_files" -eq 1 ]]; then
        local subfolder
        subfolder=$(ls -1A "$name")
        local subfolder_path="$name/$subfolder"

        if [[ -d "$subfolder_path" ]]; then
            log_info "Flattening nested structure..."
            (
                cd "$subfolder_path" || exit 1
                shopt -s dotglob
                mv * .. 2>/dev/null
            )
            rmdir "$subfolder_path"
            log_success "Structure flattened"
        fi
    fi

    # 5. Permissions
    log_info "Configuring permissions..."
    if [[ -f "$name/index.php" ]]; then
        [[ ! -d "$name/storage" ]] && mkdir -p "$name/storage"
        chmod -R 755 "$name/storage"
        log_success "Permissions configured"
    else
        log_warn "index.php not found, skipping permissions"
    fi

    echo
    log_success "Cockpit installed in './$name'"
    echo

    # Secure with Valet?
    if confirm "Secure with Valet?" Y; then
        log_header "COCKPIT TOOLBOX | Securing with Valet"
        if valet secure "$name"; then
            log_success "Site secured: https://$name.test"
        else
            log_error "Failed to secure with Valet"
        fi
    else
        log_info "Skipped (run manually: valet secure $name)"
    fi

    echo
    log_success "Installation completed!"
}

cmd_gitignore() {
    log_header "COCKPIT TOOLBOX | Create .gitignore file"

    if [[ ! -f "./tower" ]]; then
        log_error "File './tower' not found (are you in project root?)"
    fi

    if [[ -f "./.gitignore" ]]; then
        log_warn ".gitignore already exists"
        if confirm "Backup and replace?" N; then
            mv .gitignore .gitignore.backup
            log_success "Backed up to .gitignore.backup"
        else
            log_info ".gitignore creation skipped"
            return 0
        fi
    fi

    cat <<'EOF' > .gitignore
# Ignore all
*

# Include only config/ and storage/
!config/
!config/**
!storage/
!storage/**
!.gitignore
!.gitkeep

# Files to ignore even in config/ and storage/
*.diff
*.patch
.claude
.DS_Store
.project
.settings
.fleet
.idea
*.sublime-workspace
*.sublime-project
.vscode
.zed
.env
composer.lock
composer.phar
package-lock.json
bun.lockb
.phpup
/.spaces/
EOF

    log_success ".gitignore created"
}

cmd_update() {
    log_header "COCKPIT TOOLBOX | Updating Cockpit"

    if [[ ! -f "./tower" ]]; then
        log_error "File './tower' not found (are you in project root?)"
    fi

    if [[ ! -x "./tower" ]]; then
        log_info "Making './tower' executable..."
        chmod +x ./tower
    fi

    log_info "Running tower app:update..."
    if ./tower app:update; then
        log_success "Cockpit updated successfully"
    else
        log_error "Update failed"
    fi
}

display_help() {
    log_header "COCKPIT TOOLBOX"
    echo -e "${YELLOW}${BOLD}COMMANDS${RESET}"
    echo -e "  @cockpit new [name]   ${SILVER}Install Cockpit CMS in specified folder${RESET}"
    echo -e "  @cockpit gitignore    ${SILVER}Create a specific .gitignore file (keep only config/ and storage/)${RESET}"
    echo -e "  @cockpit update       ${SILVER}Update Cockpit via ./tower app:update${RESET}"
    exit 0
}

# ==============================================================================
# MAIN DISPATCHER
# ==============================================================================

main() {
    local command="${1:-}"
    local arg="${2:-}"

    case "$command" in
        new)
            cmd_new "$arg"
            ;;
        gitignore)
            cmd_gitignore
            ;;
        update)
            cmd_update
            ;;
        *)
            display_help
            ;;
    esac
}

main "$@"
