#!/bin/bash

set -euo pipefail

readonly SCRIPT_DIR="$HOME/.local/lib"
readonly SETUP_DIR="$SCRIPT_DIR/setup"

# Load common library
source "$SCRIPT_DIR/_common.sh"

# Module dispatcher
run_module() {
    local module="$1"
    local module_path="$SETUP_DIR/${module}.sh"
    
    if [[ ! -f "$module_path" ]]; then
        log_error "Module not found: ${module}"
    fi
    
    source "$module_path"
    run  # Each module exports a run() function
}

# Main menu
show_menu() {
    log_header "Setup Tool"
    
    echo "1) Identity (Git/SSH)"
    echo "2) Web Development"
    echo "3) Applications (Casks)"
    echo "4) Fonts"
    echo "0) Exit"
    echo
    
    read -p "$(echo -e "${MAGENTA}${BOLD}USER${RESET}  ${SILVER}Select module (0-5):${RESET} ")" choice
    
    case "$choice" in
        1) run_module "identity" ;;
        2) run_module "webdev" ;;
        3) run_module "casks" ;;
        4) run_module "fonts" ;;
        0) log_info "Exiting"; exit 0 ;;
        *) log_error "Invalid choice: $choice" ;;
    esac
}

# Allow direct module execution
if [[ $# -gt 0 ]]; then
    run_module "$1"
else
    show_menu
fi